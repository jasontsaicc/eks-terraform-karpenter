# 系統架構設計文檔

作者: jasontsai  
版本: 1.0.0

## 整體架構圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              Internet Gateway                            │
└────────────────────────────┬───────────────────┬───────────────────────┘
                             │                   │
                    ┌────────▼────────┐ ┌───────▼────────┐
                    │   ALB/NLB       │ │   NAT Gateway  │
                    │  (Ingress)      │ │   (Egress)     │
                    └────────┬────────┘ └───────┬────────┘
                             │                   │
┌─────────────────────────────────────────────────────────────────────────┐
│                           AWS VPC (10.0.0.0/16)                         │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                     Public Subnets (10.0.1-3.0/24)               │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐                │  │
│  │  │    AZ-1a   │  │    AZ-1b   │  │    AZ-1c   │                │  │
│  │  └────────────┘  └────────────┘  └────────────┘                │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    Private Subnets (10.0.101-103.0/24)           │  │
│  │  ┌────────────────────────────────────────────────────────────┐ │  │
│  │  │                       EKS Control Plane                     │ │  │
│  │  │                    (AWS Managed Service)                    │ │  │
│  │  └────────────────────────────────────────────────────────────┘ │  │
│  │                                                                  │  │
│  │  ┌──────────────────────────────────────────────────────────┐   │  │
│  │  │                     EKS Worker Nodes                      │   │  │
│  │  ├──────────────────────────────────────────────────────────┤   │  │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │   │  │
│  │  │ │ Node Group  │ │   Karpenter │ │   Karpenter │        │   │  │
│  │  │ │ (On-Demand) │ │  (Spot Pool)│ │ (On-Demand) │        │   │  │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘        │   │  │
│  │  └──────────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘

## Kubernetes 層架構

┌─────────────────────────────────────────────────────────────────────────┐
│                         Kubernetes Cluster (EKS)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────── Namespaces ──────────────────────────┐    │
│  │                                                                 │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │    │
│  │  │ kube-system │  │   argocd    │  │   gitlab    │          │    │
│  │  │             │  │             │  │             │          │    │
│  │  │ • CoreDNS   │  │ • Server    │  │ • Webservice│          │    │
│  │  │ • Metrics   │  │ • Repo Srv  │  │ • Sidekiq   │          │    │
│  │  │ • ALB Ctrl  │  │ • AppCtrl   │  │ • Gitaly    │          │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │    │
│  │                                                                 │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │    │
│  │  │  karpenter  │  │ monitoring  │  │gitlab-runner│          │    │
│  │  │             │  │             │  │             │          │    │
│  │  │ • Controller│  │ • Prometheus│  │ • Runners   │          │    │
│  │  │ • Webhook   │  │ • Grafana   │  │ • Executors │          │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │    │
│  │                                                                 │    │
│  │  ┌─────────────────────────────────────────────────┐          │    │
│  │  │           Application Namespaces                 │          │    │
│  │  │   (dev, staging, prod - Managed by ArgoCD)      │          │    │
│  │  └─────────────────────────────────────────────────┘          │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘

## GitOps 工作流程

```mermaid
graph LR
    A[開發者] -->|Push Code| B[GitLab]
    B -->|Webhook| C[GitLab Runner]
    C -->|Build & Test| D[Container Registry]
    D -->|Update Manifest| E[Git Repo]
    E -->|Poll/Webhook| F[ArgoCD]
    F -->|Deploy| G[EKS Cluster]
    G -->|Metrics| H[Prometheus]
    H -->|Visualize| I[Grafana]
```

## 資料流架構

### Ingress 流量路徑
```
Internet → Route53 → ALB/NLB → Ingress Controller → Service → Pods
```

### Egress 流量路徑
```
Pods → Service → NAT Gateway → Internet Gateway → Internet
```

### 內部通訊
```
Pod ↔ Pod (通過 Service 或直接)
Pod → CoreDNS (服務發現)
Pod → API Server (Kubernetes 控制)
```

## 安全架構

### 網路安全層
```
┌─────────────────────────────────────────┐
│          Security Groups                 │
├─────────────────────────────────────────┤
│ • ALB SG: 允許 80/443 from 0.0.0.0/0   │
│ • Node SG: 允許 ALB SG + 內部通訊       │
│ • RDS SG: 僅允許 Node SG                │
└─────────────────────────────────────────┘
```

### IAM 角色架構
```
┌────────────────────────────────────────────┐
│              IAM Roles (IRSA)              │
├────────────────────────────────────────────┤
│ • EKS Cluster Role                         │
│ • Node Instance Role                       │
│ • Karpenter Controller Role                │
│ • ALB Controller Role                      │
│ • EBS CSI Driver Role                      │
│ • GitLab Runner Role                       │
│ • External Secrets Role                    │
└────────────────────────────────────────────┘
```

## 儲存架構

```
┌─────────────────────────────────────────────┐
│             Storage Classes                  │
├─────────────────────────────────────────────┤
│ • gp3 (Default): 通用 SSD                   │
│ • gp3-encrypted: 加密 SSD                   │
│ • io2: 高性能 SSD                           │
│ • efs: 共享檔案系統                         │
└─────────────────────────────────────────────┘
```

## 監控與可觀測性

```
┌──────────────────────────────────────────────┐
│            Observability Stack               │
├──────────────────────────────────────────────┤
│                                              │
│  Metrics:                                    │
│  ┌─────────────────────────────────┐        │
│  │ Prometheus → Thanos → Grafana   │        │
│  └─────────────────────────────────┘        │
│                                              │
│  Logs:                                       │
│  ┌─────────────────────────────────┐        │
│  │ Fluent Bit → CloudWatch Logs    │        │
│  └─────────────────────────────────┘        │
│                                              │
│  Traces:                                     │
│  ┌─────────────────────────────────┐        │
│  │ OpenTelemetry → X-Ray           │        │
│  └─────────────────────────────────┘        │
│                                              │
│  Alerts:                                     │
│  ┌─────────────────────────────────┐        │
│  │ AlertManager → Slack/Email      │        │
│  └─────────────────────────────────┘        │
└──────────────────────────────────────────────┘
```

## 災難恢復架構

### 備份策略
```
┌─────────────────────────────────────────────┐
│              Backup Strategy                 │
├─────────────────────────────────────────────┤
│ • ETCD: 每日快照到 S3                       │
│ • PV: EBS 快照（每日）                      │
│ • GitLab: 資料庫 + 儲存庫備份（每日）       │
│ • ArgoCD: 配置備份到 Git                    │
│ • Secrets: AWS Secrets Manager              │
└─────────────────────────────────────────────┘
```

### 故障恢復
```
┌─────────────────────────────────────────────┐
│           Failure Recovery                   │
├─────────────────────────────────────────────┤
│ • 節點故障: Karpenter 自動替換              │
│ • AZ 故障: 自動故障轉移到其他 AZ           │
│ • 區域故障: 跨區域備份恢復                  │
│ • 資料損壞: 從快照恢復                      │
└─────────────────────────────────────────────┘
```

## 成本優化架構

### 資源分配策略
```
Production Environment:
├── Critical Workloads → On-Demand Instances
├── Stateful Services → On-Demand + EBS
└── Batch/Async Jobs → Spot Instances

Development Environment:
├── All Workloads → Spot Instances
└── Minimal Replicas → Cost Optimization
```

### 自動擴展策略
```
┌─────────────────────────────────────────────┐
│          Auto-scaling Strategy               │
├─────────────────────────────────────────────┤
│ HPA (Horizontal Pod Autoscaler):            │
│ • CPU: 70% threshold                        │
│ • Memory: 80% threshold                     │
│ • Custom Metrics: Request rate              │
│                                              │
│ VPA (Vertical Pod Autoscaler):              │
│ • Right-sizing recommendations              │
│ • Auto-update for non-critical              │
│                                              │
│ Karpenter (Node Autoscaler):                │
│ • Provisioning: < 30 seconds                │
│ • Deprovisioning: After 30s idle            │
│ • Spot preference: 70%                      │
└─────────────────────────────────────────────┘
```

## 技術堆疊總結

| 類別 | 技術 | 版本 | 用途 |
|------|------|------|------|
| 容器平台 | AWS EKS | 1.30 | Kubernetes 管理 |
| IaC | Terraform | 1.5+ | 基礎設施即代碼 |
| GitOps | ArgoCD | 2.11 | 持續部署 |
| CI/CD | GitLab | Latest | 原始碼管理與 CI |
| 節點管理 | Karpenter | 0.35+ | 自動節點擴展 |
| Ingress | AWS LB Controller | 2.7 | 負載均衡管理 |
| 監控 | Prometheus | 2.45+ | 指標收集 |
| 視覺化 | Grafana | 10+ | 資料視覺化 |
| 日誌 | CloudWatch | - | 集中式日誌 |
| 密鑰管理 | External Secrets | 0.9+ | 密鑰同步 |

## 網路拓撲

### 生產環境建議配置
```
Region: ap-southeast-1 (Singapore)
├── VPC: 10.0.0.0/16
├── Public Subnets:
│   ├── AZ-1a: 10.0.1.0/24
│   ├── AZ-1b: 10.0.2.0/24
│   └── AZ-1c: 10.0.3.0/24
├── Private Subnets:
│   ├── AZ-1a: 10.0.101.0/24
│   ├── AZ-1b: 10.0.102.0/24
│   └── AZ-1c: 10.0.103.0/24
└── Database Subnets:
    ├── AZ-1a: 10.0.201.0/24
    └── AZ-1b: 10.0.202.0/24
```

## 性能基準

| 指標 | 目標值 | 實際值 |
|------|--------|--------|
| API 回應時間 | < 200ms | ~ 150ms |
| Pod 啟動時間 | < 30s | ~ 20s |
| 節點擴展時間 | < 60s | ~ 45s |
| 部署時間 | < 5min | ~ 3min |
| 可用性 | 99.95% | 99.97% |
| RTO | < 1hr | ~ 30min |
| RPO | < 15min | ~ 10min |

---
作者: jasontsai  
最後更新: 2024